From 175bba4a7a2379ecd243de99243e4edb9b0a1340 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bj=C3=B6rn=20Bidar?= <bjorn.bidar@jolla.com>
Date: Thu, 25 Jan 2024 10:43:49 +0200
Subject: [PATCH] Allow parallel installation of OpenSSL 3.x without changing
 default openssl
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Bj√∂rn Bidar <bjorn.bidar@jolla.com>
---
 Configurations/unix-Makefile.tmpl          | 16 ++++++------
 Configure                                  |  2 +-
 INSTALL.md                                 |  2 +-
 NEWS.md                                    |  4 +++
 VMS/openssl_utils.com.in                   |  2 +-
 apps/CA.pl.in                              |  8 +++---
 apps/build.info                            |  8 +++---
 apps/tsget.in                              |  2 +-
 doc/HOWTO/certificates.txt                 |  2 +-
 doc/man1/CA.pl.pod                         | 30 +++++++++++-----------
 doc/man1/openssl-ca.pod.in                 |  4 +--
 doc/man1/openssl-rehash.pod.in             |  8 +++---
 doc/man1/tsget.pod                         | 26 +++++++++----------
 doc/man3/OPENSSL_config.pod                |  2 +-
 doc/man3/SSL_CTX_load_verify_locations.pod |  4 +--
 include/internal/common.h                  |  2 +-
 test/recipes/80-test_ca.t                  | 10 ++++----
 tools/build.info                           |  2 +-
 tools/c_rehash.in                          |  6 ++---
 19 files changed, 72 insertions(+), 68 deletions(-)

diff --git a/Configurations/unix-Makefile.tmpl b/Configurations/unix-Makefile.tmpl
index 8ddb1282af..2f4832aa2b 100644
--- a/Configurations/unix-Makefile.tmpl
+++ b/Configurations/unix-Makefile.tmpl
@@ -692,14 +692,14 @@ install_ssldirs:
 			: {- output_on() if windowsdll(); "" -}; \
 		fi; \
 	done
-	@$(ECHO) "install $(SRCDIR)/apps/openssl.cnf -> $(DESTDIR)$(OPENSSLDIR)/openssl.cnf.dist"
-	@cp $(SRCDIR)/apps/openssl.cnf "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf.new"
-	@chmod 644 "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf.new"
+	@$(ECHO) "install $(SRCDIR)/apps/openssl-3.cnf -> $(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf.dist"
+	@cp $(SRCDIR)/apps/openssl-3.cnf "$(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf.new"
+	@chmod 644 "$(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf.new"
 	@mv -f  "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf.new" "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf.dist"
-	@if [ ! -f "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf" ]; then \
-		$(ECHO) "install $(SRCDIR)/apps/openssl.cnf -> $(DESTDIR)$(OPENSSLDIR)/openssl.cnf"; \
-		cp $(SRCDIR)/apps/openssl.cnf "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf"; \
-		chmod 644 "$(DESTDIR)$(OPENSSLDIR)/openssl.cnf"; \
+	@if [ ! -f "$(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf" ]; then \
+		$(ECHO) "install $(SRCDIR)/apps/openssl-3.cnf -> $(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf"; \
+		cp $(SRCDIR)/apps/openssl-3.cnf "$(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf"; \
+		chmod 644 "$(DESTDIR)$(OPENSSLDIR)/openssl-3.cnf"; \
 	fi
 	@$(ECHO) "install $(SRCDIR)/apps/ct_log_list.cnf -> $(DESTDIR)$(OPENSSLDIR)/ct_log_list.cnf.dist"
 	@cp $(SRCDIR)/apps/ct_log_list.cnf "$(DESTDIR)$(OPENSSLDIR)/ct_log_list.cnf.new"
@@ -1165,7 +1165,7 @@ check-format: ## Evaluate C code according to OpenSSL coding standards
 
 generate_apps:
 	( cd $(SRCDIR); $(PERL) VMS/VMSify-conf.pl \
-				< apps/openssl.cnf > apps/openssl-vms.cnf )
+				< apps/openssl-3.cnf > apps/openssl-vms.cnf )
 
 generate_crypto_bn:
 	( cd $(SRCDIR); $(PERL) crypto/bn/bn_prime.pl > crypto/bn/bn_prime.h )
diff --git a/Configure b/Configure
index cbba1749b5..cf6f0179af 100755
--- a/Configure
+++ b/Configure
@@ -56,7 +56,7 @@ EOF
 #               directories bin, lib, include, share/man, share/doc/openssl
 #               This becomes the value of INSTALLTOP in Makefile
 #               (Default: /usr/local)
-# --openssldir  OpenSSL data area, such as openssl.cnf, certificates and keys.
+# --openssldir  OpenSSL data area, such as openssl-3.cnf, certificates and keys.
 #               If it's a relative directory, it will be added on the directory
 #               given with --prefix.
 #               This becomes the value of OPENSSLDIR in Makefile and in C.
diff --git a/INSTALL.md b/INSTALL.md
index 37b57027f4..ba5d07df08 100644
--- a/INSTALL.md
+++ b/INSTALL.md
@@ -631,7 +631,7 @@ This is only supported on systems where loading of shared libraries is supported
 
 ### no-autoload-config
 
-Don't automatically load the default `openssl.cnf` file.
+Don't automatically load the default `openssl-3.cnf` file.
 
 Typically OpenSSL will automatically load a system config file which configures
 default SSL options.
diff --git a/NEWS.md b/NEWS.md
index 5b07e2748a..f60ab0d1f2 100644
--- a/NEWS.md
+++ b/NEWS.md
@@ -104,6 +104,10 @@ documentation and example code.
 As always, bug reports and issues relating to OpenSSL can be [filed on our issue
 tracker][issue tracker].
 
+IMPORTANT: For compatibility with OpenSSL 1.1, the OpenSSL master
+configuration file openssl.cnf has been renamed to openssl-3.cnf.
+
+
 OpenSSL 3.1
 -----------
 
diff --git a/VMS/openssl_utils.com.in b/VMS/openssl_utils.com.in
index 900d0462c5..9f3460e946 100644
--- a/VMS/openssl_utils.com.in
+++ b/VMS/openssl_utils.com.in
@@ -8,7 +8,7 @@ $	OPENSSL		:== $OSSL$EXE:OPENSSL'v'
 $
 $	IF F$TYPE(PERL) .EQS. "STRING"
 $	THEN
-$	    C_REHASH	:== 'PERL' OSSL$EXE:c_rehash.pl
+$	    C_REHASH	:== 'PERL' OSSL$EXE:c_rehash-3.pl
 $	ELSE
 $	    WRITE SYS$ERROR "NOTE: no perl => no C_REHASH"
 $	ENDIF
diff --git a/apps/CA.pl.in b/apps/CA.pl.in
index 2c31ee6c8d..cc802a2ba7 100644
--- a/apps/CA.pl.in
+++ b/apps/CA.pl.in
@@ -123,10 +123,10 @@ sub run
 if ( $WHAT =~ /^(-\?|-h|-help)$/ ) {
     print STDERR <<EOF;
 Usage:
-    CA.pl -newcert | -newreq | -newreq-nodes | -xsign | -sign | -signCA | -signcert | -crl | -newca [-extra-cmd parameter]
-    CA.pl -pkcs12 [certname]
-    CA.pl -verify certfile ...
-    CA.pl -revoke certfile [reason]
+    CA-3.pl -newcert | -newreq | -newreq-nodes | -xsign | -sign | -signCA | -signcert | -crl | -newca [-extra-cmd parameter]
+    CA-3.pl -pkcs12 [certname]
+    CA-3.pl -verify certfile ...
+    CA-3.pl -revoke certfile [reason]
 EOF
     exit 0;
 }
diff --git a/apps/build.info b/apps/build.info
index 020d129f8c..12d98f682b 100644
--- a/apps/build.info
+++ b/apps/build.info
@@ -81,10 +81,10 @@ IF[{- !$disabled{apps} -}]
     SOURCE[openssl]=openssl.rc
   ENDIF
 
-  SCRIPTS{misc}=CA.pl
-  SOURCE[CA.pl]=CA.pl.in
+  SCRIPTS{misc}=CA-3.pl
+  SOURCE[CA-3.pl]=CA.pl.in
   # linkname tells build files that a symbolic link or copy of this script
   # without extension must be installed as well.  Unix or Unix lookalike only.
-  SCRIPTS{misc,linkname=tsget}=tsget.pl
-  SOURCE[tsget.pl]=tsget.in
+  SCRIPTS{misc,linkname=tsget-3}=tsget-3.pl
+  SOURCE[tsget-3.pl]=tsget.in
 ENDIF
diff --git a/apps/tsget.in b/apps/tsget.in
index 8eab6a8f1f..d8a4b71207 100644
--- a/apps/tsget.in
+++ b/apps/tsget.in
@@ -47,7 +47,7 @@ sub create_curl {
     $curl->setopt(CURLOPT_VERBOSE, 1) if $options{d};
     $curl->setopt(CURLOPT_FAILONERROR, 1);
     $curl->setopt(CURLOPT_USERAGENT,
-        "OpenTSA tsget.pl/openssl-{- $config{full_version} -}");
+        "OpenTSA tsget-3.pl/openssl-{- $config{full_version} -}");
 
     # Options for POST method.
     $curl->setopt(CURLOPT_UPLOAD, 1);
diff --git a/doc/HOWTO/certificates.txt b/doc/HOWTO/certificates.txt
index 78ab97b419..17b2c6cca5 100644
--- a/doc/HOWTO/certificates.txt
+++ b/doc/HOWTO/certificates.txt
@@ -16,7 +16,7 @@ Certificate authorities should read https://www.openssl.org/docs/apps/ca.html.
 In all the cases shown below, the standard configuration file, as
 compiled into openssl, will be used.  You may find it in /etc/,
 /usr/local/ssl/ or somewhere else.  By default the file is named
-openssl.cnf and is described at https://www.openssl.org/docs/apps/config.html.
+openssl-3.cnf and is described at https://www.openssl.org/docs/apps/config.html.
 You can specify a different configuration file using the
 '-config {file}' argument with the commands shown below.
 
diff --git a/doc/man1/CA.pl.pod b/doc/man1/CA.pl.pod
index e05775cdca..4cecb4168e 100644
--- a/doc/man1/CA.pl.pod
+++ b/doc/man1/CA.pl.pod
@@ -2,16 +2,16 @@
 
 =head1 NAME
 
-CA.pl - friendlier interface for OpenSSL certificate programs
+CA-3.pl - friendlier interface for OpenSSL certificate programs
 
 =head1 SYNOPSIS
 
-B<CA.pl>
+B<CA-3.pl>
 B<-?> |
 B<-h> |
 B<-help>
 
-B<CA.pl>
+B<CA-3.pl>
 B<-newcert> |
 B<-newreq> |
 B<-newreq-nodes> |
@@ -23,15 +23,15 @@ B<-crl> |
 B<-newca>
 [B<-extra-I<cmd>> I<parameter>]
 
-B<CA.pl> B<-pkcs12> [I<certname>]
+B<CA-3.pl> B<-pkcs12> [I<certname>]
 
-B<CA.pl> B<-verify> I<certfile> ...
+B<CA-3.pl> B<-verify> I<certfile> ...
 
-B<CA.pl> B<-revoke> I<certfile> [I<reason>]
+B<CA-3.pl> B<-revoke> I<certfile> [I<reason>]
 
 =head1 DESCRIPTION
 
-The B<CA.pl> script is a perl script that supplies the relevant command line
+The B<CA-3.pl> script is a perl script that supplies the relevant command line
 arguments to the L<openssl(1)> command for some common certificate operations.
 It is intended to simplify the process of certificate creation and management
 by the use of some simple options.
@@ -42,13 +42,13 @@ over the behaviour of the certificate commands call the L<openssl(1)> command
 directly.
 
 Most of the filenames mentioned below can be modified by editing the
-B<CA.pl> script.
+B<CA-3.pl> script.
 
-Under some environments it may not be possible to run the B<CA.pl> script
+Under some environments it may not be possible to run the B<CA-3.pl> script
 directly (for example Win32) and the default configuration file location may
 be wrong. In this case the command:
 
- perl -S CA.pl
+ perl -S CA-3.pl
 
 can be used and the B<OPENSSL_CONF> environment variable can be set to point to
 the correct path of the configuration file.
@@ -158,15 +158,15 @@ See the individual command documentation for more information.
 
 Create a CA hierarchy:
 
- CA.pl -newca
+ CA-3.pl -newca
 
 Complete certificate creation example: create a CA, create a request, sign
 the request and finally create a PKCS#12 file containing it.
 
- CA.pl -newca
- CA.pl -newreq
- CA.pl -sign
- CA.pl -pkcs12 "My Test Certificate"
+ CA-3.pl -newca
+ CA-3.pl -newreq
+ CA-3.pl -sign
+ CA-3.pl -pkcs12 "My Test Certificate"
 
 =head1 ENVIRONMENT
 
diff --git a/doc/man1/openssl-ca.pod.in b/doc/man1/openssl-ca.pod.in
index fe09f85c2c..4de9b3c7f1 100644
--- a/doc/man1/openssl-ca.pod.in
+++ b/doc/man1/openssl-ca.pod.in
@@ -767,7 +767,7 @@ the database has to be kept in memory.
 This command really needs rewriting or the required functionality
 exposed at either a command or interface level so that a more user-friendly
 replacement could handle things properly. The script
-B<CA.pl> helps a little but not very much.
+B<CA-3.pl> helps a little but not very much.
 
 Any fields in a request that are not present in a policy are silently
 deleted. This does not happen if the B<-preserveDN> option is used. To
@@ -846,7 +846,7 @@ L<openssl(1)>,
 L<openssl-req(1)>,
 L<openssl-spkac(1)>,
 L<openssl-x509(1)>,
-L<CA.pl(1)>,
+L<CA-3.pl(1)>,
 L<config(5)>,
 L<x509v3_config(5)>
 
diff --git a/doc/man1/openssl-rehash.pod.in b/doc/man1/openssl-rehash.pod.in
index 380ad6dd2a..50d6fa573d 100644
--- a/doc/man1/openssl-rehash.pod.in
+++ b/doc/man1/openssl-rehash.pod.in
@@ -6,7 +6,7 @@ Original text by James Westby.
 
 =head1 NAME
 
-openssl-rehash, c_rehash - Create symbolic links to files named by the hash
+openssl-rehash, c_rehash-3 - Create symbolic links to files named by the hash
 values
 
 =head1 SYNOPSIS
@@ -22,7 +22,7 @@ B<rehash>
 {- $OpenSSL::safe::opt_provider_synopsis -}
 [I<directory>] ...
 
-B<c_rehash>
+B<c_rehash-3>
 [B<-h>]
 [B<-help>]
 [B<-old>]
@@ -34,7 +34,7 @@ B<c_rehash>
 =head1 DESCRIPTION
 
 This command is generally equivalent to the external
-script B<c_rehash>,
+script B<c_rehash-3>,
 except for minor differences noted below.
 
 B<openssl rehash> scans directories and calculates a hash value of
@@ -75,7 +75,7 @@ more than one such object appears in the file.
 
 =head2 Script Configuration
 
-The B<c_rehash> script
+The B<c_rehash-3> script
 uses the B<openssl> program to compute the hashes and
 fingerprints. If not found in the user's B<PATH>, then set the
 B<OPENSSL> environment variable to the full pathname.
diff --git a/doc/man1/tsget.pod b/doc/man1/tsget.pod
index 66c0ba6299..660bbd372f 100644
--- a/doc/man1/tsget.pod
+++ b/doc/man1/tsget.pod
@@ -2,11 +2,11 @@
 
 =head1 NAME
 
-tsget - Time Stamping HTTP/HTTPS client
+tsget-3 - Time Stamping HTTP/HTTPS client
 
 =head1 SYNOPSIS
 
-B<tsget>
+B<tsget-3>
 B<-h> I<server_url>
 [B<-e> I<extension>]
 [B<-o> I<output>]
@@ -33,7 +33,7 @@ connection if more than one requests are specified on the command line.
 This command sends the following HTTP request for each timestamp request:
 
         POST url HTTP/1.1
-        User-Agent: OpenTSA tsget.pl/<version>
+        User-Agent: OpenTSA tsget-3.pl/<version>
         Host: <host>:<port>
         Pragma: no-cache
         Content-Type: application/timestamp-query
@@ -130,7 +130,7 @@ be read from the standard input.
 
 =head1 ENVIRONMENT VARIABLES
 
-The B<TSGET> environment variable can optionally contain default
+The B<TSGET-3> environment variable can optionally contain default
 arguments. The content of this variable is added to the list of command line
 arguments.
 
@@ -144,42 +144,42 @@ absolute path.
 Get a timestamp response for F<file1.tsq> over HTTP, output is written to
 F<file1.tsr>:
 
-  tsget -h http://tsa.opentsa.org:8080/tsa file1.tsq
+  tsget-3 -h http://tsa.opentsa.org:8080/tsa file1.tsq
 
 Get a timestamp response for F<file1.tsq> and F<file2.tsq> over HTTP showing
 progress, output is written to F<file1.reply> and F<file2.reply> respectively:
 
-  tsget -h http://tsa.opentsa.org:8080/tsa -v -e .reply \
+  tsget-3 -h http://tsa.opentsa.org:8080/tsa -v -e .reply \
         file1.tsq file2.tsq
 
 Create a timestamp request, write it to F<file3.tsq>, send it to the server and
 write the response to F<file3.tsr>:
 
   openssl ts -query -data file3.txt -cert | tee file3.tsq \
-        | tsget -h http://tsa.opentsa.org:8080/tsa \
+        | tsget-3 -h http://tsa.opentsa.org:8080/tsa \
         -o file3.tsr
 
 Get a timestamp response for F<file1.tsq> over HTTPS without client
 authentication:
 
-  tsget -h https://tsa.opentsa.org:8443/tsa \
+  tsget-3 -h https://tsa.opentsa.org:8443/tsa \
         -C cacerts.pem file1.tsq
 
 Get a timestamp response for F<file1.tsq> over HTTPS with certificate-based
 client authentication (it will ask for the passphrase if F<client_key.pem> is
 protected):
 
-  tsget -h https://tsa.opentsa.org:8443/tsa -C cacerts.pem \
+  tsget-3 -h https://tsa.opentsa.org:8443/tsa -C cacerts.pem \
         -k client_key.pem -c client_cert.pem file1.tsq
 
-You can shorten the previous command line if you make use of the B<TSGET>
+You can shorten the previous command line if you make use of the B<TSGET-3>
 environment variable. The following commands do the same as the previous
 example:
 
-  TSGET='-h https://tsa.opentsa.org:8443/tsa -C cacerts.pem \
+  TSGET-3='-h https://tsa.opentsa.org:8443/tsa -C cacerts.pem \
         -k client_key.pem -c client_cert.pem'
-  export TSGET
-  tsget file1.tsq
+  export TSGET-3
+  tsget-3 file1.tsq
 
 =head1 SEE ALSO
 
diff --git a/doc/man3/OPENSSL_config.pod b/doc/man3/OPENSSL_config.pod
index 60f1c5a658..c9d8da5789 100644
--- a/doc/man3/OPENSSL_config.pod
+++ b/doc/man3/OPENSSL_config.pod
@@ -17,7 +17,7 @@ see L<openssl_user_macros(7)>:
 
 =head1 DESCRIPTION
 
-OPENSSL_config() configures OpenSSL using the standard B<openssl.cnf> and
+OPENSSL_config() configures OpenSSL using the standard B<openssl-3.cnf> and
 reads from the application section B<appname>. If B<appname> is NULL then
 the default section, B<openssl_conf>, will be used.
 Errors are silently ignored.
diff --git a/doc/man3/SSL_CTX_load_verify_locations.pod b/doc/man3/SSL_CTX_load_verify_locations.pod
index b0dc8babd2..458d501947 100644
--- a/doc/man3/SSL_CTX_load_verify_locations.pod
+++ b/doc/man3/SSL_CTX_load_verify_locations.pod
@@ -82,7 +82,7 @@ If more than one CA certificate with the same name hash value exist, the
 extension must be different (e.g. 9d66eef0.0, 9d66eef0.1 etc). The search
 is performed in the ordering of the extension number, regardless of other
 properties of the certificates.
-Use the B<c_rehash> utility to create the necessary links.
+Use the B<c_rehash-3> utility to create the necessary links.
 
 The certificates in B<CApath> are only looked up when required, e.g. when
 building the certificate chain or when actually performing the verification
@@ -157,7 +157,7 @@ Prepare the directory /some/where/certs containing several CA certificates
 for use as B<CApath>:
 
  cd /some/where/certs
- c_rehash .
+ c_rehash-3 .
 
 =head1 SEE ALSO
 
diff --git a/include/internal/common.h b/include/internal/common.h
index 15666f1110..4ac34dabd4 100644
--- a/include/internal/common.h
+++ b/include/internal/common.h
@@ -78,7 +78,7 @@ __owur static ossl_inline int ossl_assert_int(int expr, const char *exprstr,
     ossl_uintmax_t align_int;   \
     void *align_ptr
 
-# define OPENSSL_CONF             "openssl.cnf"
+# define OPENSSL_CONF             "openssl-3.cnf"
 
 # ifndef OPENSSL_SYS_VMS
 #  define X509_CERT_AREA          OPENSSLDIR
diff --git a/test/recipes/80-test_ca.t b/test/recipes/80-test_ca.t
index 916f952a0c..e1fce6aba3 100644
--- a/test/recipes/80-test_ca.t
+++ b/test/recipes/80-test_ca.t
@@ -39,22 +39,22 @@ require_ok(srctop_file("test", "recipes", "tconversion.pl"));
      my $cakey = src_file("ca-key.pem");
      $ENV{OPENSSL_CONFIG} = qq(-config "$cnf");
      skip "failed creating CA structure", 4
-         if !ok(run(perlapp(["CA.pl","-newca",
+         if !ok(run(perlapp(["CA-3.pl","-newca",
                              "-extra-req", "-key $cakey"], stdin => undef)),
                 'creating CA structure');
 
      my $eekey = src_file("ee-key.pem");
      $ENV{OPENSSL_CONFIG} = qq(-config "$cnf");
      skip "failed creating new certificate request", 3
-         if !ok(run(perlapp(["CA.pl","-newreq",
+         if !ok(run(perlapp(["CA-3.pl","-newreq",
                              '-extra-req', "-outform DER -section userreq -key $eekey"])),
                 'creating certificate request');
      $ENV{OPENSSL_CONFIG} = qq(-rand_serial -inform DER -config "$std_openssl_cnf");
      skip "failed to sign certificate request", 2
-         if !is(yes(cmdstr(perlapp(["CA.pl", "-sign"]))), 0,
+         if !is(yes(cmdstr(perlapp(["CA-3.pl", "-sign"]))), 0,
                 'signing certificate request');
 
-     ok(run(perlapp(["CA.pl", "-verify", "newcert.pem"])),
+     ok(run(perlapp(["CA-3.pl", "-verify", "newcert.pem"])),
         'verifying new certificate');
 
      skip "CT not configured, can't use -precert", 1
@@ -62,7 +62,7 @@ require_ok(srctop_file("test", "recipes", "tconversion.pl"));
 
      my $eekey2 = src_file("ee-key-3072.pem");
      $ENV{OPENSSL_CONFIG} = qq(-config "$cnf");
-     ok(run(perlapp(["CA.pl", "-precert", '-extra-req', "-section userreq -key $eekey2"], stderr => undef)),
+     ok(run(perlapp(["CA-3.pl", "-precert", '-extra-req', "-section userreq -key $eekey2"], stderr => undef)),
         'creating new pre-certificate');
 }
 
diff --git a/tools/build.info b/tools/build.info
index 059e582345..40e21ac640 100644
--- a/tools/build.info
+++ b/tools/build.info
@@ -1,5 +1,5 @@
 {- our $c_rehash_name =
-       $config{target} =~ /^(VC|vms)-/ ? "c_rehash.pl" : "c_rehash";
+       $config{target} =~ /^(VC|vms)-/ ? "c_rehash.pl" : "c_rehash-3";
    "" -}
 IF[{- !$disabled{apps} -}]
   SCRIPTS={- $c_rehash_name -}
diff --git a/tools/c_rehash.in b/tools/c_rehash.in
index 4dd1b44682..85bdc64d92 100644
--- a/tools/c_rehash.in
+++ b/tools/c_rehash.in
@@ -8,7 +8,7 @@
 # in the file LICENSE in the source distribution or at
 # https://www.openssl.org/source/license.html
 
-# Perl c_rehash script, scan all files in a directory
+# Perl c_rehash-3 script, scan all files in a directory
 # and add symbolic links to their hash values.
 
 my $dir = {- quotify1($config{openssldir}) -};
@@ -44,7 +44,7 @@ while ( $ARGV[0] =~ /^-/ ) {
 }
 
 sub help {
-    print "Usage: c_rehash [-old] [-h] [-help] [-v] [dirs...]\n";
+    print "Usage: c_rehash-3 [-old] [-h] [-help] [-v] [dirs...]\n";
     print "   -old use old-style digest\n";
     print "   -h or -help print this help text\n";
     print "   -v print files removed and linked\n";
@@ -73,7 +73,7 @@ if (! -x $openssl) {
         }
     }
     if ($found == 0) {
-        print STDERR "c_rehash: rehashing skipped ('openssl' program not available)\n";
+        print STDERR "c_rehash-3: rehashing skipped ('openssl' program not available)\n";
         exit 0;
     }
 }
-- 
2.43.0

